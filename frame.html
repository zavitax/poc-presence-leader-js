<!DOCTYPE html>
<html>
    <body>
        <script src="eventEmitter.js"></script>
        <script src="eventRealtimeClient.js"></script>
        <script src="presenceRealtimeClient.js"></script>
        <script src="leaderElectionRealtimeClient.js"></script>
        <script src="indexedQueueTracker.js"></script>
        <script src="sharedIndexedQueueTrackerLeader.js"></script>
        <script src="sharedIndexedQueueTrackerFollower.js"></script>
        <script src="indexedQueueProcessingCoordinator.js"></script>
        <script src="coordinatedMessageQueueRealtimeClient.js"></script>
        <script src="distributedStateRealtimeClient.js"></script>

        <div id="debug"></div>
        <div id="aux"></div>
        <div id="status"></div>
        <div id="aux_status"></div>
        <div id="component_status"></div>

        <script>
            const uuid = crypto.randomUUID();

            function report_component_status(...args) {
                document.getElementById("component_status").innerText = JSON.stringify([ ... args ]);
            }

            async function main() {
                function sleep(ms) {
                    return new Promise(resolve => {
                        setTimeout(resolve, ms);
                    });
                }

                function debug(...args) {
                    document.getElementById("debug").innerText = JSON.stringify([ ... args ]);
                    //console.log(uuid, ...args);
                }

                function aux(...args) {
                    document.getElementById("aux").innerText = JSON.stringify([ ... args ]);
                }

                function status(...args) {
                    document.getElementById("status").innerText = JSON.stringify([ ... args ]);
                }

                function aux_status(...args) {
                    document.getElementById("aux_status").innerText = JSON.stringify([ ... args ]);
                }

                function color(bgColor = 'inherit') {
                    document.body.style.backgroundColor = bgColor;
                }

                debug('wait');

                //await sleep(Math.floor(10000 * Math.random()));

                debug('start');
                color('#eeeeee');

                function createRealtimeEventEmitterProvider() {
                    return new WebsocketRealtimeEventEmitterProvider({
                        websocketUrl: 'ws://localhost:8080',
                    });
                    /*
                    return new BroadcastChannelRealtimeEventEmitterProvider({
                        broadcastChannelName: 'test',
                    });*/
                }

                function strcmp(av, bv) {
                    if (av < bv) return -1;
                    if (av > bv) return 1;
                    return 0;
                }

                function statecmp(a, b) {
                    return strcmp(a?.data?.data?.queueIndex, b?.data?.queueIndex) || strcmp(a?.src, b?.src);
                }

                const indexedQueueTracker = new IndexedQueueTracker({
                    eventRealtimeClient: new EventRealtimeClient({
                        realtimeEventEmitterProvider: createRealtimeEventEmitterProvider(),
                    }),
                    formatIndexCallback: (data) => {
                        return data.timestamp.toString() + '.' + data.nonce.toString();
                    },
                    requestIndexedQueueItemsFromStorageCallback: async ({
                        queueIndex
                    }) => {
                        const [ timestamp, nonce ] = queueIndex.split('.');

                        const url = `http://localhost:8181/?timestamp=${timestamp}&nonce=${nonce}`;

                        console.log('requestIndexedQueueItemsFromStorageCallback: ', queueIndex);

                        const response = await window.fetch(url);
                        const json = await response.json();

                        return json;
                    }
                });

                const leaderElectionRealtimeClient = new LeaderElectionRealtimeClient({
                    presenceRealtimeClient: new PresenceRealtimeClient({
                        eventRealtimeClient: new EventRealtimeClient({
                            realtimeEventEmitterProvider: createRealtimeEventEmitterProvider(),
                        }),
                        warmupTimeMilliseconds: 6000,
                        heartbeatIntervalMilliseconds: 3000,
                    }),
                    compareParticipantsCallback: (a, b) => {
                        return statecmp(a, b);
                    },
                });

                function processQueueItemAsyncCallback({ queueIndex, data }) {
                    return new Promise(resolve => {
                        if (!leaderElectionRealtimeClient.isLeader) {
                            color("#eeeeee");
                        } else {
                            color('#88ee88');
                        }

                        const delayMs = Math.floor(Math.random() * 5000);

                        status('got event: ', data, '    ack delayMs: ', delayMs);;

                        report_component_status('working: ', queueIndex);
                        setTimeout(() => {
                            report_component_status('idle: ', queueIndex);
                            if (!leaderElectionRealtimeClient.isLeader) {
                                color("#aaaaaa");
                            } else {
                                color('#44aa44');
                            }

                            resolve();
                        }, delayMs);
                    });
                }

                const indexedQueueProcessingCoordinator = new IndexedQueueProcessingCoordinator({
                    indexedQueueTracker,
                    leaderElectionRealtimeClient,
                    processQueueItemAsyncCallback,
                });

                /*
                const coordinatedMessageQueueRealtimeClient = new CoordinatedMessageQueueRealtimeClient({
                    leaderElectionRealtimeClient,
                    eventRealtimeClient: new EventRealtimeClient({
                        realtimeEventEmitterProvider: createRealtimeEventEmitterProvider(),
                    }),
                });*/

                leaderElectionRealtimeClient.on('leaderStateChanged', ({ isLeader }) => {
                    debug(
                        'isLeader: ',
                        leaderElectionRealtimeClient.isLeader
                    );

                    if (leaderElectionRealtimeClient.isLeader) {
                        color('#88ee88');
                    } else {
                        color('#ee8888');
                    }
                });

                aux(
                    'init participants: ',
                    leaderElectionRealtimeClient.presenceRealtimeClient.participants.length
                );
                leaderElectionRealtimeClient.presenceRealtimeClient.on('change', () => {
                    aux(
                        'participants: ',
                        leaderElectionRealtimeClient.presenceRealtimeClient.participants.length
                    );
                });


                /*
                coordinatedMessageQueueRealtimeClient.on('message', event => {
                    const { src, ack, ackToken, data } = event;

                    if (!leaderElectionRealtimeClient.isLeader) {
                        color("#eeeeee");
                    } else {
                        color('#88ee88');
                    }

                    const delayMs = Math.floor(Math.random() * 3000);

                    status('got event: from ', src, ' -> ', data.data, '    ack delayMs: ', delayMs);;

                    setTimeout(() => {
                        //console.log(uuid, ' ack()');

                        ack();

                        if (!leaderElectionRealtimeClient.isLeader) {
                            color("#aaaaaa");
                        } else {
                            color('#44aa44');
                        }
                    }, delayMs);
                });

                await sleep(6000);

                let i = 0;
                function enqueue() {
                    ++i;
                    if (coordinatedMessageQueueRealtimeClient.queue.length < 10) {
                        coordinatedMessageQueueRealtimeClient.enqueue({ data: { seq: i } });
                    }
                    setTimeout(enqueue, 1000);
                }
                enqueue();

                window.onbeforeunload = function(event) {
                    event.preventDefault();

                    coordinatedMessageQueueRealtimeClient.dispose();

                    event.returnValue = "test";
                }
                */

                /*
                debug('dispose');
                color('#888888');
                //await leaderElectionRealtimeClient.dispose();
                await coordinatedMessageQueueRealtimeClient.dispose();
                debug('disposed');
                color('#444444');
                */
            }

            main();
        </script>
    </body>
</html>