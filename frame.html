<!DOCTYPE html>
<html>
    <body>
        <script src="eventEmitter.js"></script>
        <script src="eventRealtimeClient.js"></script>
        <script src="presenceRealtimeClient.js"></script>
        <script src="leaderElectionRealtimeClient.js"></script>
        <script src="coordinatedMessageQueueRealtimeClient.js"></script>

        <div id="debug"></div>
        <div id="aux"></div>
        <div id="status"></div>

        <script>
            const uuid = crypto.randomUUID();

            async function main() {
                function sleep(ms) {
                    return new Promise(resolve => {
                        setTimeout(resolve, ms);
                    });
                }

                function debug(...args) {
                    document.getElementById("debug").innerText = JSON.stringify([ ... args ]);
                    //console.log(uuid, ...args);
                }

                function aux(...args) {
                    document.getElementById("aux").innerText = JSON.stringify([ ... args ]);
                }

                function status(...args) {
                    document.getElementById("status").innerText = JSON.stringify([ ... args ]);
                }

                function color(bgColor = 'inherit') {
                    document.body.style.backgroundColor = bgColor;
                }

                debug('wait');

                //await sleep(Math.floor(10000 * Math.random()));

                debug('start');
                color('#eeeeee');

                function createRealtimeEventEmitterProvider() {
                    return new WebsocketRealtimeEventEmitterProvider({
                        websocketUrl: 'ws://localhost:8080',
                    });
                    /*
                    return new BroadcastChannelRealtimeEventEmitterProvider({
                        broadcastChannelName: 'test',
                    });*/
                }

                const leaderElectionRealtimeClient = new LeaderElectionRealtimeClient({
                    presenceRealtimeClient: new PresenceRealtimeClient({
                        eventRealtimeClient: new EventRealtimeClient({
                            realtimeEventEmitterProvider: createRealtimeEventEmitterProvider(),
                        }),
                        heartbeatIntervalMilliseconds: 5000,
                        requestDataCallback: () => {
                            return {
                                key: uuid,
                            };
                        }
                    }),
                    requestSortParticipantsCallback: (a, b) => {
                        const av = a.data.key;
                        const bv = b.data.key;

                        if (av < bv) return -1;
                        if (av > bv) return 1;
                        return 0;
                    },
                });

                const coordinatedMessageQueueRealtimeClient = new CoordinatedMessageQueueRealtimeClient({
                    leaderElectionRealtimeClient,
                    eventRealtimeClient: new EventRealtimeClient({
                        realtimeEventEmitterProvider: createRealtimeEventEmitterProvider(),
                    }),
                });

                leaderElectionRealtimeClient.on('leaderStateChanged', ({ isLeader }) => {
                    debug(
                        'isLeader: ',
                        leaderElectionRealtimeClient.isLeader
                    );

                    if (leaderElectionRealtimeClient.isLeader) {
                        color('#88ee88');
                    } else {
                        color('#eeeeee');
                    }
                });

                aux(
                    'init participants: ',
                    leaderElectionRealtimeClient.presenceRealtimeClient.participants.length
                );
                leaderElectionRealtimeClient.presenceRealtimeClient.on('change', () => {
                    aux(
                        'participants: ',
                        leaderElectionRealtimeClient.presenceRealtimeClient.participants.length
                    );
                });

                coordinatedMessageQueueRealtimeClient.on('message', event => {
                    const { src, ack, ackToken, data } = event;

                    if (!leaderElectionRealtimeClient.isLeader) {
                        color("#eeeeee");
                    } else {
                        color('#88ee88');
                    }

                    const delayMs = Math.floor(Math.random() * 3000);

                    status('got event: from ', src, ' -> ', data.data, '    ack delayMs: ', delayMs);;

                    setTimeout(() => {
                        //console.log(uuid, ' ack()');

                        ack();

                        if (!leaderElectionRealtimeClient.isLeader) {
                            color("#aaaaaa");
                        } else {
                            color('#44aa44');
                        }
                    }, delayMs);
                });

                await sleep(6000);

                let i = 0;
                function enqueue() {
                    ++i;
                    if (coordinatedMessageQueueRealtimeClient.queue.length < 10) {
                        coordinatedMessageQueueRealtimeClient.enqueue({ data: { seq: i } });
                    }
                    setTimeout(enqueue, 1000);
                }
                enqueue();

                window.onbeforeunload = function(event) {
                    event.preventDefault();

                    coordinatedMessageQueueRealtimeClient.dispose();

                    event.returnValue = "test";
                }

                /*
                debug('dispose');
                color('#888888');
                //await leaderElectionRealtimeClient.dispose();
                await coordinatedMessageQueueRealtimeClient.dispose();
                debug('disposed');
                color('#444444');
                */
            }

            main();
        </script>
    </body>
</html>